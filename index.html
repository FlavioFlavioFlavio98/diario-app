<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diario V13.0 Modular</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2965/2965316.png">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="login-screen">
        <h1 style="color:var(--accent)">Diario V13.0</h1>
        <button class="btn-primary" onclick="login()">Accedi con Google</button>
    </div>

    <div id="app" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div class="header-top">
                <div class="date-navigator">
                    <input type="month" id="date-picker" onchange="changeDate(this.value)">
                    <span id="db-status" class="db-status">Ready</span>
                </div>
                
                <div style="display:flex; gap:5px; align-items:center;">
                    <button class="tool-btn" onclick="openTagExplorer()" title="Esplora Tag"><span class="material-icons-round">tag</span></button>
                    <button class="tool-btn" onclick="openCoachManager()" title="Gestisci Coach"><span class="material-icons-round">menu_book</span></button>
                    <button class="tool-btn" onclick="openStats()" title="Stats"><span class="material-icons-round">bar_chart</span></button>
                    <button class="tool-btn" onclick="openSettings()" title="Settings"><span class="material-icons-round">settings</span></button>
                    <img id="user-pic" src="" style="width:28px; height:28px; border-radius:50%; border:2px solid var(--accent); margin-left:5px;">
                </div>
            </div>
            
            <div id="ai-coach-area">
                <div class="ai-title" id="ai-title">Coach</div>
                <div id="ai-message"></div>
                <div class="ai-actions" id="ai-actions"></div>
            </div>
        </header>

        <div class="toolbar">
            <button class="tool-btn" onclick="triggerBrainstorm()" title="AI Brainstorming"><span class="material-icons-round" style="color:#ffd700;">lightbulb</span></button>
            <button class="tool-btn" onclick="openWalkTalk()" title="Walk & Talk"><span class="material-icons-round" style="color:#00e676;">pets</span></button>
            <button class="tool-btn" onclick="generateAiSummary()" title="Riassunto AI"><span class="material-icons-round" style="color:#29b6f6;">auto_awesome</span></button>
            
            <div class="separator"></div>
            
            <button class="tool-btn" onclick="format('bold')"><span class="material-icons-round">format_bold</span></button>
            <button class="tool-btn" onclick="format('italic')"><span class="material-icons-round">format_italic</span></button>
            <button class="tool-btn" onclick="triggerImageUpload()"><span class="material-icons-round">add_photo_alternate</span></button>
            <button class="tool-btn" id="mic-btn" onclick="toggleDictation()"><span class="material-icons-round">mic</span></button>
            
            <div class="mood-bar">
                <button class="mood-btn" onclick="insertMood('ğŸ˜„')">ğŸ˜„</button>
                <button class="mood-btn" onclick="insertMood('ğŸ˜')">ğŸ˜</button>
                <button class="mood-btn" onclick="insertMood('ğŸ˜”')">ğŸ˜”</button>
                <button class="mood-btn" onclick="insertMood('ğŸ˜¡')">ğŸ˜¡</button>
                <button class="mood-btn" onclick="insertMood('ğŸ’¡')">ğŸ’¡</button>
            </div>
        </div>
        
        <div id="metrics-bar">
            <div class="metric-item" title="Tempo sessione attuale">
                <span>â±ï¸</span> <span id="session-timer" class="metric-val">00:00</span>
            </div>
            <div class="metric-item" title="Parole scritte oggi">
                <span>ğŸ“ Sessione:</span> <span id="count-today" class="metric-val">0</span>
            </div>
            <div class="metric-item" title="Parole totali nel diario">
                <span>ğŸ“š Totale:</span> <span id="count-global" class="metric-val">Loading...</span>
            </div>
            <div class="metric-item" title="Peso del file attuale (max 1000KB)">
                <span>ğŸ’¾</span> <span id="file-weight" class="metric-val">0 KB</span>
            </div>
        </div>

        <input type="file" id="img-input" accept="image/*" onchange="handleImageUpload(this)">

        <main>
            <div id="editor" contenteditable="true" onkeyup="handleKeyUp(event)"></div>
        </main>
    </div>

    <div id="summary-modal" class="modal"><div class="modal-content"><div style="display:flex; justify-content:space-between;"><h2>Riassunto AI ğŸ¤–</h2><button onclick="document.getElementById('summary-modal').classList.remove('open')" style="background:none; border:none; color:inherit; font-size:1.5rem;">&times;</button></div><div id="ai-summary-content"></div></div></div>
    
    <div id="tag-modal" class="modal"><div class="modal-content"><div style="display:flex; justify-content:space-between;"><h2>Esplora Tag</h2><button onclick="document.getElementById('tag-modal').classList.remove('open')" style="background:none; border:none; color:inherit; font-size:1.5rem;">&times;</button></div><div style="padding:10px 0; border-bottom:1px solid #444; margin-bottom:10px;"><div id="tag-cloud"></div></div><div id="tag-results"></div></div></div>
    
    <div id="walk-talk-modal" class="modal" style="background:var(--bg);"><div id="walk-talk-content" class="modal-content" style="height:100%; width:100%; max-width:100%; border-radius:0; justify-content: center;"><div style="position:absolute; top:20px; right:20px;"><button onclick="closeWalkTalk()" style="background:none; border:none; color:var(--text); font-size:2rem;">&times;</button></div><h2 style="color:var(--accent); margin-bottom:10px;">Walk & Talk</h2><div id="walk-status">Pronto?</div><div id="walk-transcript">Premi il microfono.</div><button id="walk-mic-btn" class="big-mic-btn" onclick="toggleWalkSession()"><span class="material-icons-round" style="font-size:3rem;">mic</span></button></div></div>
    
    <div id="coach-manager-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Gestione Coach ğŸ§ </h2>
                <button onclick="document.getElementById('coach-manager-modal').classList.remove('open')" style="background:none; border:none; color:inherit; font-size:1.5rem;">&times;</button>
            </div>
            
            <div class="coach-input-area">
                <input type="text" id="new-prompt-input" placeholder="Scrivi una nuova domanda..." onkeyup="if(event.key==='Enter') addCoachPrompt()">
                <button class="btn-primary" style="padding: 8px 15px; border-radius: 8px;" onclick="addCoachPrompt()">Aggiungi</button>
            </div>
            
            <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Le domande sono ordinate per frequenza d'uso:</div>
            
            <div id="coach-list-container">
                </div>
        </div>
    </div>

    <div id="stats-modal" class="modal"><div class="modal-content"><div style="display:flex; justify-content:space-between;"><h2>Statistiche</h2><button onclick="document.getElementById('stats-modal').classList.remove('open')" style="background:none; border:none; color:inherit; font-size:1.5rem;">&times;</button></div><div style="margin:20px 0;">Parole Oggi: <span id="stat-count-today" style="color:var(--accent); font-weight:bold;">0</span></div><canvas id="chartCanvas" height="150"></canvas></div></div>

    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width:300px;">
            <div style="display:flex; justify-content:space-between;"><h2>Opzioni</h2><button onclick="document.getElementById('settings-modal').classList.remove('open')" style="background:none; border:none; color:inherit; font-size:1.5rem;">&times;</button></div>
            <div style="margin-top:20px;"><button style="width:100%; padding:10px;" onclick="toggleTheme()">Tema Light/Dark ğŸŒ“</button></div>
            <div style="margin-top:10px;"><button style="width:100%; padding:10px;" onclick="exportData()">ğŸ’¾ Scarica Pagina</button></div>
            <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
            <h3>ğŸ¤– Google Gemini AI</h3>
            <input type="password" id="gemini-api-key" placeholder="Incolla AIzaSy..." style="width:100%; padding:10px; margin-top:5px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:5px;">
            <button style="width:100%; padding:10px; margin-top:10px; background:var(--accent); color:white; border:none; border-radius:5px;" onclick="saveApiKey()">Salva Chiave</button>
        </div>
    </div>

    <script type="module" src="app.js"></script>
<script type="module" src="app.js?v=14"></script>
</body>
</html>